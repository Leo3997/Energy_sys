<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>得鹿山能耗优化中心 - 智能看板</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            /* 核心色板 */
            --bg-dark: #020617;
            --bg-gradient: radial-gradient(circle at 50% 0%, #1e293b, #020617);

            /* 卡片玻璃态配置 */
            --card-bg: rgba(30, 41, 59, 0.4);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-backdrop: blur(12px);

            /* 文字颜色 */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            /* 强调色 (霓虹感) */
            --accent-green: #10b981;
            --accent-green-glow: rgba(16, 185, 129, 0.4);

            --accent-blue: #3b82f6;
            --accent-blue-glow: rgba(59, 130, 246, 0.4);

            --accent-purple: #8b5cf6;
            --accent-purple-glow: rgba(139, 92, 246, 0.4);

            --accent-red: #ef4444;
            --accent-orange: #f59e0b;

            --sidebar-width: 240px;
        }

        body {
            font-family: 'Inter', 'Microsoft YaHei', system-ui, sans-serif;
            background: var(--bg-dark);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            /* Remove default padding, handled by main-content */
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
            display: flex;
            /* Flex layout for sidebar */
        }

        /* Layout */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--card-border);
            padding: 24px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 32px;
            box-sizing: border-box;
        }

        /* Nav Menu */
        .nav-menu {
            list-style: none;
            padding: 0;
            margin-top: 40px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-link.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        /* Logs Table */
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .logs-table th {
            text-align: left;
            padding: 16px;
            color: var(--text-muted);
            font-weight: 500;
            border-bottom: 1px solid var(--card-border);
        }

        .logs-table td {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            color: var(--text-secondary);
        }

        .logs-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .log-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
        }

        .log-highlight {
            color: var(--accent-blue);
            font-family: 'JetBrains Mono';
        }

        body {
            font-family: 'Inter', 'Microsoft YaHei', system-ui, sans-serif;
            background: var(--bg-dark);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            padding: 24px;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        /* 顶部导航 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 0 8px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .header-title-gradient {
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--accent-blue);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        .status-badge {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 15px var(--accent-green-glow);
            transition: all 0.3s;
        }

        .status-badge.offline {
            border-color: var(--accent-red);
            color: var(--accent-red);
            box-shadow: none;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: currentColor;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        /* 布局网格 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 卡片基础样式 */
        .card {
            background: var(--card-bg);
            backdrop-filter: var(--card-backdrop);
            -webkit-backdrop-filter: var(--card-backdrop);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* 卡片光效遮罩 */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0.5;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .card-title {
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            font-size: 18px;
            opacity: 0.8;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
        }

        /* 数据展示 */
        .metric-group {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.05em;
        }

        /* 特大号数字 */
        .metric-value.hero {
            font-size: 42px;
            background: linear-gradient(to right, #fff, #cbd5e1);
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }

        .metric-unit {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .metric-sub {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }

        /* 进度条样式 */
        .progress-container {
            height: 6px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 99px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 99px;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        /* 进度条条纹动画 */
        .progress-bar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(45deg,
                    rgba(255, 255, 255, 0.15) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.15) 75%,
                    transparent 75%,
                    transparent);
            background-size: 20px 20px;
            animation: move-stripes 2s linear infinite;
        }

        @keyframes move-stripes {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 20px 0;
            }
        }

        /* 终端日志样式 */
        .terminal-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin-top: auto;
            /* Push to bottom */
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: #10b981;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .terminal-box::before {
            content: ">_ SYSTEM LOG";
            display: block;
            font-size: 9px;
            color: #475569;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 2px;
        }

        /* 动画类 */
        .pulse-dot {
            width: 6px;
            height: 6px;
            background-color: var(--accent-red);
            border-radius: 50%;
            animation: pulse-red 2s infinite;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .alarm-border {
            border-color: var(--accent-red) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2) !important;
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* 响应式 Grid 布局控制 */
        .col-4 {
            grid-column: span 4;
        }

        .col-8 {
            grid-column: span 8;
        }

        .col-3 {
            grid-column: span 3;
        }

        .col-6 {
            grid-column: span 6;
        }

        .col-12 {
            grid-column: span 12;
        }

        @media (max-width: 1200px) {

            .col-4,
            .col-8,
            .col-3,
            .col-6 {
                grid-column: span 6;
            }
        }

        @media (max-width: 768px) {
            .grid-container {
                display: flex;
                flex-direction: column;
            }
        }

        /* --- NEW UI POLISH CLASSES --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            transition: all 0.3s;
        }

        .glass-panel:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .shimmer-text {
            background: linear-gradient(to right, #fcd34d 20%, #fff 50%, #fcd34d 80%);
            background-size: 200% auto;
            color: #fcd34d;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }

        .metric-label-icon {
            font-size: 14px;
            margin-bottom: 4px;
            opacity: 0.7;
        }
    </style>
    <style>
        /* 新增：报警与提示样式 */
        .alert-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.05);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .alert-critical {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
        }

        .alert-warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            color: #fcd34d;
        }

        .alert-notice {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            color: #93c5fd;
        }

        .alert-confidence {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            margin-left: auto;
            font-family: 'JetBrains Mono';
        }

        /* 新增：系统原理图样式 */
        .principle-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 100%;
            padding: 20px;
            position: relative;
        }

        .flow-node {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            width: 120px;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .flow-node.active {
            border-color: var(--accent-green);
            box-shadow: 0 0 15px var(--accent-green-glow);
        }

        .flow-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .flow-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .flow-arrow {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.1));
            margin: 0 10px;
            position: relative;
            z-index: 1;
        }

        .flow-arrow::after {
            content: '►';
            position: absolute;
            right: -6px;
            top: -7px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 10px;
        }

        /* View Switching Logic */
        .view-section {
            display: none;
            width: 100%;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <style>
        /* ========== 开屏动画样式 ========== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }

        .splash-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .splash-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent-blue);
            border-radius: 50%;
            opacity: 0;
            animation: float-particle 4s infinite;
        }

        .particle:nth-child(1) {
            left: 10%;
            animation-delay: 0s;
        }

        .particle:nth-child(2) {
            left: 30%;
            animation-delay: 0.5s;
        }

        .particle:nth-child(3) {
            left: 50%;
            animation-delay: 1s;
        }

        .particle:nth-child(4) {
            left: 70%;
            animation-delay: 1.5s;
        }

        .particle:nth-child(5) {
            left: 85%;
            animation-delay: 2s;
        }

        .particle:nth-child(6) {
            left: 20%;
            animation-delay: 2.5s;
        }

        @keyframes float-particle {
            0% {
                bottom: -10px;
                opacity: 0;
                transform: translateX(0) scale(0.5);
            }

            20% {
                opacity: 0.8;
            }

            80% {
                opacity: 0.3;
            }

            100% {
                bottom: 100%;
                opacity: 0;
                transform: translateX(30px) scale(1);
            }
        }

        .splash-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            z-index: 1;
        }

        .splash-logo-container {
            position: relative;
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .splash-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            z-index: 2;
            animation: logo-pulse 2s ease-in-out infinite;
        }

        @keyframes logo-pulse {

            0%,
            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
            }

            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 25px rgba(59, 130, 246, 0.6));
            }
        }

        .splash-logo-ring {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 2px solid transparent;
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: ring-spin 1.5s linear infinite;
        }

        .splash-logo-ring.delay-1 {
            width: 100px;
            height: 100px;
            border-top-color: var(--accent-purple);
            animation-duration: 2s;
            animation-direction: reverse;
        }

        .splash-logo-ring.delay-2 {
            width: 140px;
            height: 140px;
            border-top-color: var(--accent-green);
            animation-duration: 2.5s;
        }

        @keyframes ring-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .splash-title {
            font-size: 42px;
            font-weight: 700;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #fff 0%, #3b82f6 50%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.05em;
            animation: title-glow 2s ease-in-out infinite alternate;
        }

        @keyframes title-glow {
            0% {
                filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.3));
            }

            100% {
                filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
            }
        }

        .splash-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin: 0 0 40px 0;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .splash-loader {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .splash-loader-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple), var(--accent-green));
            background-size: 200% 100%;
            border-radius: 4px;
            animation: loader-progress 2.5s ease-out forwards, loader-shimmer 1s linear infinite;
        }

        @keyframes loader-progress {
            0% {
                width: 0%;
            }

            20% {
                width: 25%;
            }

            50% {
                width: 60%;
            }

            80% {
                width: 85%;
            }

            100% {
                width: 100%;
            }
        }

        @keyframes loader-shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .splash-loading-text {
            font-size: 12px;
            color: var(--text-muted);
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            animation: text-blink 1s step-end infinite;
        }

        @keyframes text-blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* 主内容初始隐藏 */
        .app-layout {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .app-layout.visible {
            opacity: 1;
        }
    </style>
</head>

<body>

    <!-- 开屏动画 Splash Screen -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="splash-content">
            <div class="splash-logo-container">
                <div class="splash-logo-ring"></div>
                <div class="splash-logo-ring delay-1"></div>
                <div class="splash-logo-ring delay-2"></div>
                <img src="得鹿山纯白.png" alt="得鹿山" class="splash-logo">
            </div>
            <h1 class="splash-title">得鹿山</h1>
            <p class="splash-subtitle">能耗优化中心</p>
            <div class="splash-loader">
                <div class="splash-loader-bar"></div>
            </div>
            <p class="splash-loading-text">系统初始化中...</p>
        </div>
    </div>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div
                style="display: flex; align-items: center; gap: 12px; padding-bottom: 20px; border-bottom: 1px solid var(--card-border);">
                <img src="得鹿山纯白.png" alt="得鹿山" style="width: 100px; height: 100px; object-fit: contain;">
                <div style="font-weight: 700; font-size: 16px; letter-spacing: -0.5px;">得鹿山<span
                        style="color:var(--text-muted); font-weight:400;">Energy</span></div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="switchView('dashboard', this)">
                        <i class="ri-dashboard-3-line nav-icon"></i>仪表盘
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchView('logs', this)">
                        <i class="ri-file-list-3-line nav-icon"></i>运行日志
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchView('devices', this)">
                        <i class="ri-server-line nav-icon"></i>设备概览
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="switchView('settings', this)">
                        <i class="ri-settings-line nav-icon"></i>系统设置
                    </a>
                </li>
            </ul>

            <div
                style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--card-border); font-size: 11px; color: var(--text-muted);">
                <div>System V2.1.0</div>
                <div style="margin-top:4px;">Connected: <span id="conn-status-side"
                        style="color:var(--accent-green)">Online</span></div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-section active">
                <div class="header">
                    <div class="header-left">
                        <h1>
                            <span class="header-title-gradient">得鹿山能耗优化中心</span>
                            <span
                                style="font-size: 14px; color: var(--text-secondary); margin-top: 4px; font-weight: 400;">当前设备：<span
                                    id="current-device-label"
                                    style="color: var(--accent-blue); font-weight: 500;">energy*1*1</span></span>
                        </h1>
                    </div>
                    <div class="header-controls">
                        <button class="control-btn" onclick="toggleChat()"
                            style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--accent-blue);">
                            <i class="ri-robot-line" style="margin-right: 6px;"></i> 智能助手
                        </button>
                        <div style="text-align: right; margin-left:16px;">
                            <div class="time-display" id="time-display">--:--:--</div>
                            <div class="date-display" id="date-display">----/--/--</div>
                        </div>
                    </div>
                </div>

                <div class="grid-container">

                    <div class="card col-4" style="border-top: 2px solid var(--accent-green);">
                        <div class="card-header">
                            <span class="card-title"><span style="color: var(--accent-green)">●</span>
                                累计优化收益</span>
                            <i class="ri-money-cny-circle-line card-icon"></i>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            <div class="metric-group">
                                <span class="metric-value hero shimmer-text" id="total-savings-cost">0.00</span>
                                <span class="metric-unit" style="font-size: 18px;">CNY</span>
                            </div>
                            <div style="margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                                        节省电量 (Elec)</div>
                                    <div style="font-family: 'JetBrains Mono'; font-weight: 600; color: #fff;">
                                        <span id="total-savings-kwh">0.00</span> <span
                                            style="font-size: 10px; color: var(--text-muted)">kWh</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                                        节省耗材 (Oil)</div>
                                    <div
                                        style="font-family: 'JetBrains Mono'; font-weight: 600; color: var(--accent-orange);">
                                        <span id="total-savings-oil">0.00</span> <span
                                            style="font-size: 10px; color: var(--text-muted)">L</span>
                                    </div>
                                </div>
                                <div
                                    style="grid-column: span 2; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 12px; margin-top: 4px;">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
                                        已优化空转 (Idle Opt)
                                    </div>
                                    <div
                                        style="font-family: 'JetBrains Mono'; font-weight: 600; color: var(--accent-purple);">
                                        <span id="idle-hours">0.00</span> <span
                                            style="font-size: 10px; color: var(--text-muted)">Hours</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card col-8">
                        <div class="card-header">
                            <span class="card-title">
                                实时功率监控
                                <span class="pulse-dot"></span>
                            </span>
                            <div style="text-align: right;">
                                <span style="font-size: 12px; color: var(--text-muted);">动态基线</span>
                                <div
                                    style="font-family: 'JetBrains Mono'; font-weight: bold; color: var(--text-secondary);">
                                    <span id="baseline-power">0.00</span> kW
                                </div>
                            </div>
                        </div>

                        <!-- Grid Quality Metrics (Refined Layout) -->
                        <div style="display: flex; gap: 24px; margin-bottom: 24px; align-items: stretch;">

                            <!-- Main Power Display -->
                            <div style="flex: 1.2; display: flex; flex-direction: column; justify-content: flex-end;">
                                <div style="display: flex; align-items: baseline; gap: 8px;">
                                    <span class="metric-value" id="current-power"
                                        style="font-size: 56px; line-height: 1; letter-spacing: -2px;">0.00</span>
                                    <span class="metric-unit" style="font-size: 16px; margin-bottom: 8px;">kW</span>
                                </div>
                            </div>

                            <!-- Detail Panels -->
                            <div style="flex: 2; display: flex; gap: 12px;">
                                <div class="glass-panel">
                                    <span class="metric-label-icon"><i class="ri-flashlight-line"></i> 电压 (V)</span>
                                    <div
                                        style="font-family: 'JetBrains Mono'; font-weight: 700; font-size: 18px; color: #fff;">
                                        <span id="grid-volts">--</span> <span
                                            style="font-size:12px; color: var(--text-muted)">V</span>
                                    </div>
                                </div>
                                <div class="glass-panel">
                                    <span class="metric-label-icon"><i class="ri-pulse-line"></i> 电流 (A)</span>
                                    <div
                                        style="font-family: 'JetBrains Mono'; font-weight: 700; font-size: 18px; color: #fff;">
                                        <span id="grid-amps">--</span> <span
                                            style="font-size:12px; color: var(--text-muted)">A</span>
                                    </div>
                                </div>
                                <div class="glass-panel">
                                    <span class="metric-label-icon"><i class="ri-pie-chart-2-line"></i> 功率因数</span>
                                    <div
                                        style="font-family: 'JetBrains Mono'; font-weight: 700; font-size: 18px; color: #fff;">
                                        <span id="grid-pf">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: auto;">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; color: var(--text-muted); font-family: 'JetBrains Mono';">
                                <span>0 kW</span>
                                <span id="max-scale-label">10 kW</span>
                            </div>
                            <div
                                style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative;">
                                <div id="baseline-marker"
                                    style="position: absolute; top: -4px; bottom: -4px; width: 2px; background: #fff; z-index: 10; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: left 0.5s;">
                                </div>

                                <div id="power-bar"
                                    style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); border-radius: 6px; box-shadow: 0 0 15px var(--accent-purple-glow); transition: width 0.5s, background 0.3s;">
                                </div>
                            </div>
                            <div style="display: flex; justify-content: center; margin-top: 4px;">
                                <span id="baseline-label"
                                    style="font-size: 10px; color: rgba(255,255,255,0.5); font-family: 'JetBrains Mono'; transition: margin-left 0.5s;">
                                    <i class="ri-arrow-up-s-fill"></i> 标准基线</span>
                            </div>
                        </div>
                    </div>

                    <!-- System Principle & Alerts Row (Moved Up) -->
                    <div class="card col-6" style="height: 340px;">
                        <div class="card-header">
                            <span class="card-title">系统优化原理</span>
                            <i class="ri-brain-line card-icon"></i>
                        </div>
                        <div class="principle-flow">
                            <div class="flow-node active" id="node-monitor">
                                <i class="ri-radar-line flow-icon"></i>
                                <span class="flow-label">监测</span>
                                <div style="font-size:10px; margin-top:4px; color:#64748b;">实时数据采集</div>
                            </div>
                            <div class="flow-arrow"></div>
                            <div class="flow-node" id="node-detect">
                                <i class="ri-search-eye-line flow-icon"></i>
                                <span class="flow-label">检测</span>
                                <div style="font-size:10px; margin-top:4px; color:#64748b;">异常/空转识别
                                </div>
                            </div>
                            <div class="flow-arrow"></div>
                            <div class="flow-node" id="node-act">
                                <i class="ri-flashlight-fill flow-icon"></i>
                                <span class="flow-label">控制</span>
                                <div style="font-size:10px; margin-top:4px; color:#64748b;">自动执行策略</div>
                            </div>
                        </div>
                        <div style="text-align: center; color: var(--text-muted); font-size: 11px; margin-top: -20px;">
                            AI 循环间隔: 60s | 置信度阈值: >85%
                        </div>
                    </div>

                    <div class="card col-6" style="height: 340px;">
                        <div class="card-header">
                            <span class="card-title">智能洞察与报警</span>
                            <i class="ri-notification-3-line card-icon"></i>
                        </div>
                        <div id="alerts-container" style="overflow-y: auto; padding-right: 4px;">
                            <div class="alert-item alert-notice">
                                <span><i class="ri-information-line"></i> 系统已初始化，等待分析数据...</span>
                            </div>
                        </div>
                    </div>

                    <div class="card col-8" style="height: 380px;">
                        <div class="card-header">
                            <span class="card-title">能耗趋势</span>
                            <div id="forecast-container"
                                style="display:none; font-family: 'JetBrains Mono'; font-size: 12px; color: var(--accent-purple);">
                                <i class="ri-magic-line"></i> 预测峰值: <span id="forecast-val"
                                    style="font-weight: bold;">--</span>
                            </div>
                        </div>
                        <div id="power-chart" style="width: 100%; height: 100%;"></div>
                    </div>

                    <div class="card col-4" style="height: 380px;">
                        <div class="card-header">
                            <span class="card-title">节能构成分析</span>
                        </div>
                        <div id="savings-chart" style="width: 100%; height: 100%;"></div>
                    </div>

                    <!-- Dynamic Device Container -->
                    <div id="devices-container" style="display: contents;">
                        <!-- JS will populate devices here -->
                    </div>

                    <!-- TEMPLATES -->
                    <template id="tpl-lub-card">
                        <div class="card col-6 device-card">
                            <div class="card-header">
                                <span class="card-title" style="color: var(--accent-orange)">
                                    <span class="device-name">Smart Lubrication Bot</span>
                                </span>
                                <i class="ri-robot-2-line card-icon"></i>
                            </div>
                            <!-- Control Panel (Hidden by default, toggled via UI?) Or just inline -->
                            <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                                <button class="btn-control-inject"
                                    style="background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #fcd34d; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-drop-line"></i> 强制注油
                                </button>
                                <button class="btn-control-stop"
                                    style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #fca5a5; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-stop-circle-line"></i> 紧急停止
                                </button>
                                <button class="btn-control-start"
                                    style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #6ee7b7; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-restart-line"></i> 重新启动
                                </button>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <div class="metric-value" style="font-size: 24px;">
                                        <span class="val-temp">--</span><span class="metric-unit">°C</span>
                                    </div>
                                    <div class="metric-sub">轴承温度</div>
                                </div>
                                <div>
                                    <div class="metric-value" style="font-size: 24px;">
                                        <span class="val-current">--</span><span class="metric-unit">A</span>
                                    </div>
                                    <div class="metric-sub">电机电流</div>
                                </div>
                            </div>

                            <div class="progress-container">
                                <div class="bar-temp progress-bar"
                                    style="width: 0%; background: var(--accent-orange); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);">
                                </div>
                            </div>

                            <div
                                style="margin: 12px 0; font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between;">
                                <span>AI 干预次数</span>
                                <span class="val-count" style="color: #fff; font-weight: bold;">0</span>
                            </div>

                            <div class="terminal-box val-log">
                                等待连接...
                            </div>
                        </div>
                    </template>

                    <template id="tpl-ten-card">
                        <div class="card col-6 device-card">
                            <div class="card-header">
                                <span class="card-title" style="color: var(--accent-blue)">
                                    <span class="device-name">Smart Tension Bot</span>
                                </span>
                                <i class="ri-speed-up-line card-icon"></i>
                            </div>

                            <div style="margin-bottom: 12px; display: flex; gap: 8px;">
                                <button class="btn-control-optimize"
                                    style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #93c5fd; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-magic-line"></i> 强制优化
                                </button>
                                <button class="btn-control-stop"
                                    style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #fca5a5; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-stop-circle-line"></i> 紧急停止
                                </button>
                                <button class="btn-control-start"
                                    style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #6ee7b7; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    <i class="ri-restart-line"></i> 重新启动
                                </button>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <div class="metric-value" style="font-size: 24px;">
                                        <span class="val-tension">--</span><span class="metric-unit">g</span>
                                    </div>
                                    <div class="metric-sub">纱线张力</div>
                                </div>
                                <div>
                                    <div class="metric-value" style="font-size: 24px;">
                                        <span class="val-yarn">--</span><span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-sub">纱线余量</div>
                                </div>
                            </div>

                            <div class="progress-container">
                                <div class="bar-tension progress-bar"
                                    style="width: 0%; background: var(--accent-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);">
                                </div>
                            </div>

                            <div
                                style="margin: 12px 0; font-size: 12px; color: var(--text-secondary); display: flex; justify-content: space-between;">
                                <span>优化次数</span>
                                <span class="val-count" style="color: #fff; font-weight: bold;">0</span>
                            </div>

                            <div class="terminal-box val-log">
                                等待连接...
                            </div>
                        </div>
                    </template>
                </div>
            </div> <!-- End View Dashboard -->

            <!-- Logs View -->
            <div id="view-logs" class="view-section">
                <div class="header">
                    <div class="header-left">
                        <h1>
                            <span class="header-title-gradient">运行日志</span>
                            <span
                                style="font-size: 14px; color: var(--text-secondary); margin-top: 4px; font-weight: 400;">System
                                operation and AI decision logs</span>
                        </h1>
                    </div>
                </div>

                <div class="card" style="width: 100%; min-height: 80vh;">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">时间</th>
                                <th style="width: 120px;">事件类型</th>
                                <th>详情信息</th>
                                <th style="width: 200px;">快照数据</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div> <!-- End View Logs -->

            <!-- Settings View -->
            <div id="view-settings" class="view-section">
                <div class="header">
                    <div class="header-left">
                        <h1>
                            <span class="header-title-gradient"> 系统设置</span>
                            <span
                                style="font-size: 14px; color: var(--text-secondary); margin-top: 4px; font-weight: 400;">System
                                parameters configuration and reports</span>
                        </h1>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Configuration Card -->
                    <div class="card" style="margin-bottom: 0;">
                        <h2 class="card-title" style="margin-bottom: 20px;"><i class="ri-settings-4-line"></i> 参数配置
                            (Parameters)</h2>

                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="input-group">
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 13px;">电费价格
                                    (CNY/kWh)</label>
                                <input type="number" id="setting-elec-price" step="0.01"
                                    style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 8px; color: #fff; border-radius: 4px;">
                            </div>
                            <div class="input-group">
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 13px;">润滑油价
                                    (CNY/L)</label>
                                <input type="number" id="setting-oil-price" step="0.1"
                                    style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 8px; color: #fff; border-radius: 4px;">
                            </div>
                            <div class="input-group">
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 13px;">AI单次喷注量
                                    (L)</label>
                                <input type="number" id="setting-inject-vol" step="0.0001"
                                    style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 8px; color: #fff; border-radius: 4px;">
                            </div>

                            <button onclick="saveSettings()"
                                style="margin-top: 10px; background: var(--accent-blue); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; transition: opacity 0.2s;">
                                <i class="ri-save-line"></i> 保存配置 (Save)
                            </button>
                            <div id="settings-status" style="height: 20px; font-size: 12px; margin-top: 5px;"></div>
                        </div>
                    </div>

                    <!-- Export Card -->
                    <div class="card" style="margin-bottom: 0;">
                        <h2 class="card-title" style="margin-bottom: 20px;"><i class="ri-file-download-line"></i> 数据导出
                            (Data Export)</h2>
                        <div
                            style="padding: 20px; text-align: center; border: 1px dashed rgba(255,255,255,0.2); border-radius: 8px;">
                            <i class="ri-file-excel-2-line"
                                style="font-size: 48px; color: var(--accent-green); margin-bottom: 10px; display: block;"></i>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                                导出系统中存储的所有 "自动喷油" 与 "换盘报警" 事件记录。<br>
                                文件格式: CSV (可被 Excel 打开)
                            </p>
                            <a href="javascript:void(0)" onclick="downloadReport()"
                                style="display: inline-block; background: var(--accent-green); color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                <i class="ri-download-line"></i> 下载报告 (Download Report)
                            </a>
                            <script>
                                function downloadReport() {
                                    const btn = event.currentTarget;
                                    const originalText = btn.innerHTML;
                                    btn.innerHTML = '<i class="ri-loader-4-line"></i> 正在生成...';

                                    fetch('/api/export/events')
                                        .then(response => {
                                            if (response.status !== 200) throw new Error("下载失败");
                                            return response.blob(); // 将响应转为二进制 Blob
                                        })
                                        .then(blob => {
                                            // 创建一个临时的下载链接
                                            const url = window.URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.style.display = 'none';
                                            a.href = url;
                                            // 在这里强制指定文件名，浏览器会听前端的，不依赖后端 Header
                                            a.download = 'events_report.csv';
                                            document.body.appendChild(a);
                                            a.click();
                                            window.URL.revokeObjectURL(url); // 清理内存
                                            document.body.removeChild(a);
                                            btn.innerHTML = originalText;
                                        })
                                        .catch(err => {
                                            alert('导出失败: ' + err.message);
                                            btn.innerHTML = originalText;
                                        });
                                }
                            </script>
                        </div>
                    </div>
                </div>
            </div>

    </div>

    <!-- Device Overview View -->
    <div id="view-devices" class="view-section">
        <div class="header">
            <div class="header-left">
                <h1>
                    <span class="header-title-gradient">全厂设备概览</span>
                    <span style="font-size: 14px; color: var(--text-secondary); margin-top: 4px; font-weight: 400;">
                        Discovered Devices from InfluxDB
                    </span>
                </h1>
            </div>
            <div class="header-controls">
                <button class="control-btn" onclick="fetchDeviceList()">
                    <i class="ri-refresh-line"></i> 刷新列表
                </button>
            </div>
        </div>

        <div id="device-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 24px;">
            <div style="color: var(--text-muted); padding: 20px;">Loading devices...</div>
        </div>
    </div>

    </main>
    </div>
    <script>
        // 保持原有的后端接口常量
        const API_URL = '/api/status';

        // ECharts 初始化
        let powerChart = echarts.init(document.getElementById('power-chart'));
        let savingsChart = echarts.init(document.getElementById('savings-chart'));

        // --- ECharts 配置优化 ---

        const powerOption = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(2, 6, 23, 0.8)',
                borderColor: 'rgba(255,255,255,0.1)',
                textStyle: { color: '#f8fafc', fontFamily: 'Inter' },
                axisPointer: {
                    type: 'line',
                    lineStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'transparent' },
                            { offset: 0.5, color: '#8b5cf6' },
                            { offset: 1, color: 'transparent' }
                        ])
                    }
                }
            },
            grid: {
                top: 30, right: 20, bottom: 30, left: 50,
                containLabel: true,
                borderColor: 'rgba(255,255,255,0.05)',
                show: true,
                borderWidth: 0 // 只留网格线
            },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                splitLine: { show: false },
                axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                axisLabel: { color: '#64748b', fontSize: 11, fontFamily: 'JetBrains Mono' }
            },
            yAxis: {
                type: 'value',
                scale: true,
                splitLine: {
                    show: true,
                    lineStyle: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                axisLabel: { color: '#64748b', fontFamily: 'JetBrains Mono' },
                boundaryGap: ['20%', '20%']
            },
            series: [
                {
                    name: '实测功耗',
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    symbol: 'circle',
                    symbolSize: 8,
                    itemStyle: { color: '#8b5cf6' },
                    lineStyle: {
                        width: 3,
                        color: '#8b5cf6',
                        shadowColor: 'rgba(139, 92, 246, 0.5)',
                        shadowBlur: 15
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(139, 92, 246, 0.3)' },
                            { offset: 1, color: 'rgba(139, 92, 246, 0)' }
                        ])
                    },
                    data: []
                },
                {
                    name: 'Baseline',
                    type: 'line',
                    showSymbol: false,
                    smooth: true,
                    lineStyle: {
                        type: 'dashed',
                        width: 2,
                        color: '#2dd4bf',
                        opacity: 0.6
                    },
                    data: []
                }
            ]
        };

        const savingsOption = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'item',
                backgroundColor: 'rgba(2, 6, 23, 0.9)',
                borderColor: '#334155',
                textStyle: { color: '#fff' }
            },
            legend: {
                bottom: '0%',
                left: 'center',
                itemGap: 20,
                textStyle: { color: '#94a3b8', fontSize: 12 }
            },
            series: [
                {
                    name: '节能收益',
                    type: 'pie',
                    radius: ['55%', '75%'], // 环形图
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 5,
                        borderColor: '#0f172a',
                        borderWidth: 4
                    },
                    label: { show: false },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: '#fff'
                        },
                        scale: true,
                        scaleSize: 10
                    },
                    data: []
                }
            ]
        };

        powerChart.setOption(powerOption);
        savingsChart.setOption(savingsOption);

        // 数据 Buffer
        const MAX_POINTS = 60;
        let powerData = [];
        let baselineData = [];

        // 窗口调整
        window.addEventListener('resize', () => {
            powerChart.resize();
            savingsChart.resize();
        });

        // --- JS Logic (保持核心逻辑不变，适配新ID) ---

        // 1. History Data Loading
        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                data.forEach(item => {
                    const ts = new Date(item.time);
                    if (item.field === 'power_kw') {
                        const val = item.value;
                        powerData.push({ name: ts.toString(), value: [ts, val] });

                        // [MODIFIED] Generate Dynamic Baseline for History
                        // Baseline = 1.15 * Historical Power (consistent with new real-time rule)
                        if (val > 0.1) {
                            baselineData.push({ name: ts.toString(), value: [ts, val * 1.15] });
                        } else {
                            baselineData.push({ name: ts.toString(), value: [ts, 0] });
                        }
                    }
                    // Removed old 'current_a' mock baseline block
                });

                powerData.sort((a, b) => a.value[0] - b.value[0]);
                baselineData.sort((a, b) => a.value[0] - b.value[0]);

                powerChart.setOption({
                    series: [{ data: powerData }, { data: baselineData }]
                });
            } catch (e) {
                console.error("Failed to load history:", e);
            }
        }

        // 2. WebSocket
        const socket = io();

        // --- AI Chat Logic ---
        function toggleChat() {
            const win = document.getElementById('ai-chat-window');
            if (win.style.display === 'none') {
                win.style.display = 'flex';
                // Auto focus input
                setTimeout(() => document.getElementById('ai-input').focus(), 100);
            } else {
                win.style.display = 'none';
            }
        }

        async function sendAiMessage() {
            const inputEl = document.getElementById('ai-input');
            const msg = inputEl.value.trim();
            if (!msg) return;

            // Add User Message
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `
                <div style="background: #6366f1; padding: 10px; border-radius: 8px; align-self: flex-end; max-width: 85%; color: #fff; font-size: 13px;">
                    ${msg}
                </div>
            `;
            inputEl.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // Loading State
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `
                <div id="${loadingId}" style="align-self: flex-start; color: #aaa; font-size: 12px; margin-left: 4px;">Thinking...</div>
            `;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const res = await fetch('/api/ask_ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: msg })
                });
                const data = await res.json();

                // Remove loading
                document.getElementById(loadingId).remove();

                // Add AI Response
                chatBox.innerHTML += `
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; align-self: flex-start; max-width: 85%; color: #eee; font-size: 13px; line-height: 1.4;">
                        ${data.answer}
                    </div>
                `;
            } catch (err) {
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div style="color: #ef4444; font-size: 12px;">Error connecting to AI.</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        socket.on('connect', () => {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) { // Check if element exists (it's in the dashboard view)
                statusEl.className = 'status-badge';
                statusEl.innerHTML = '<span class="status-dot"></span> Connected';
            }
            const sideStatusEl = document.getElementById('conn-status-side');
            if (sideStatusEl) {
                sideStatusEl.innerText = 'Online';
                sideStatusEl.style.color = 'var(--accent-green)';
            }
            loadHistory();
            updateTime(); // Start time update on connect
            setInterval(updateTime, 1000); // Update time every second

            // [NEW] 立即触发实时功率数据推送，无需等待60秒的后台循环
            fetch('/api/devices/switch/energy*1*1', { method: 'POST' })
                .then(res => res.json())
                .then(data => console.log('🚀 Triggered immediate power data push:', data))
                .catch(err => console.warn('Power data trigger failed:', err));
        });

        socket.on('disconnect', () => {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.className = 'status-badge offline';
                statusEl.innerHTML = '<span class="status-dot"></span> Disconnected';
            }
            const sideStatusEl = document.getElementById('conn-status-side');
            if (sideStatusEl) {
                sideStatusEl.innerText = 'Offline';
                sideStatusEl.style.color = 'var(--text-muted)';
            }
        });

        socket.on('stats_update', (stats) => {
            updateStatsUI(stats);
            // [MODIFIED] Correctly update the Savings Chart here
            updateSavingsChart(stats);
        });

        socket.on('device_update', (device) => {
            updateDeviceUI(device);
        });

        socket.on('grid_monitor_update', (data) => {
            updateMonitorUI(data);
        });

        socket.on('grid_monitor_update', (data) => {
            // [MODIFIED] Update Charts here with Real Monitor Data
            const chartPayload = {
                current_total_power: data.power_kw,
                baseline_total_power: data.baseline_kw
            };
            updatePowerChart(chartPayload);

            // 1. Update Detailed Metrics
            if (document.getElementById('grid-volts')) document.getElementById('grid-volts').innerText = data.voltage;
            if (document.getElementById('grid-amps')) document.getElementById('grid-amps').innerText = data.current;
            if (document.getElementById('grid-pf')) document.getElementById('grid-pf').innerText = data.pf;
            if (document.getElementById('idle-hours')) document.getElementById('idle-hours').innerText = data.idle_hours || '0.00';

            // ... (rest of logic remains same)

            // 2. Update Main Power (if valid)
            if (data.power_kw != null) {
                const pKw = data.power_kw;
                const bKw = data.baseline_kw;

                // Update the number text
                document.getElementById('current-power').innerText = pKw.toFixed(2);

                // Update Baseline Text
                if (bKw != null) {
                    document.getElementById('baseline-power').innerText = bKw.toFixed(2);
                } else {
                    document.getElementById('baseline-power').innerText = '--';
                }

                // Update Bar (Dynamic Scale)
                // Ensure scale covers both current power and baseline
                let maxVal = pKw;
                if (bKw != null) maxVal = Math.max(maxVal, bKw);

                // [MODIFIED] User requested bar to be longer (visible).
                // Previous floor was 200kW, which made 4kW look like 2%.
                // Loosened floor to 10kW so it adapts better to low power devices.
                const maxScale = Math.max(10, maxVal * 1.2);
                document.getElementById('max-scale-label').innerText = maxScale.toFixed(0) + ' kW';

                const pct = Math.min(100, (pKw / maxScale) * 100);
                const bar = document.getElementById('power-bar');
                if (bar) {
                    bar.style.width = pct + '%';
                    bar.style.background = 'linear-gradient(90deg, var(--accent-blue), var(--accent-purple))';
                    bar.style.boxShadow = '0 0 15px var(--accent-purple-glow)';
                }

                // Update Baseline Marker
                const marker = document.getElementById('baseline-marker');
                const baseLabel = document.getElementById('baseline-label');

                if (bKw != null) {
                    const bPct = Math.min(100, (bKw / maxScale) * 100);
                    if (marker) {
                        marker.style.display = 'block';
                        marker.style.left = bPct + '%';
                    }
                    if (baseLabel) {
                        baseLabel.style.display = 'block';
                        // Optional: Move label to follow marker? 
                        // For now keep it centered or static to avoid clutter
                    }
                } else {
                    if (marker) marker.style.display = 'none';
                    if (baseLabel) baseLabel.style.display = 'none';
                }
            }

            // 3. Forecast
            if (data.forecast_peak_kw) {
                const el = document.getElementById('forecast-val');
                if (el) {
                    el.innerText = data.forecast_peak_kw.toFixed(2) + ' kW';
                    document.getElementById('forecast-container').style.display = 'block';
                }
            }

            // 4. Alerts
            // This section was previously updating a generic 'system-alerts' div.
            // Now alerts are handled by updateMonitorUI which populates 'alerts-container'
            // The old 'system-alerts' div is no longer present in the new structure.
            // So, this block can be removed or adapted if a new generic alert display is needed.
            // For now, I'll comment it out as updateMonitorUI handles the primary alert display.
            /*
            const alertBox = document.getElementById('system-alerts');
            if (alertBox) {
                if (data.alerts && data.alerts.length > 0) {
                    alertBox.innerHTML = data.alerts.map(a => `<div style="color: #ef4444; font-size: 11px; margin-bottom: 4px; display: flex; align-items: center; gap:4px;"><span>⚠️</span> ${a}</div>`).join('');
                    // Optional: Highlight system status if alert exists
                } else {
                    alertBox.innerHTML = '<div style="color: #10b981; font-size: 11px; opacity: 0.7;">✅ All systems normal</div>';
                }
            }
            */
        });

        function updatePowerChart(stats) {
            const now = new Date();
            if (!stats) return;

            // Line Chart Update
            const pVal = stats.current_total_power;
            powerData.push({ name: now.toString(), value: [now, pVal] });

            // Baseline: Use passed value (Remote) or Fallback to calc
            let bVal = stats.baseline_total_power;
            if (bVal == null || bVal === 0) {
                bVal = pVal > 0.1 ? pVal * 1.15 : 0;
            }
            baselineData.push({ name: now.toString(), value: [now, bVal] });

            if (powerData.length > MAX_POINTS) powerData.shift();
            if (baselineData.length > MAX_POINTS) baselineData.shift();

            powerChart.setOption({
                series: [
                    { data: powerData },
                    { data: baselineData }
                ]
            });
        }

        function updateSavingsChart(stats) {
            if (!stats) return;

            // Pie Chart Update
            const oil_liters = stats.total_savings_oil_liters || 0;
            const oil_cost = oil_liters * 20.0;
            // Now we use explicit electric cost from backend
            const elec_cost = stats.total_savings_elec_cost || 0;

            let pieData = [];
            // Lower threshold slightly to ensure visibility when > 0.01
            if (oil_cost <= 0.0001 && elec_cost <= 0.0001) {
                pieData = [{ value: 1, name: 'Waiting...', itemStyle: { color: '#334155' } }];
            } else {
                pieData = [
                    { value: parseFloat(elec_cost.toFixed(4)), name: '电力 (Elec)', itemStyle: { color: '#3b82f6' } },
                    { value: parseFloat(oil_cost.toFixed(4)), name: '耗材 (Oil)', itemStyle: { color: '#f59e0b' } }
                ];
            }

            savingsChart.setOption({
                series: [{ data: pieData }]
            });
        }

        function updateStatsUI(stats) {
            // 更新文本: 仅保留 Savings 相关数据的更新
            document.getElementById('total-savings-cost').innerText = stats.total_savings_cost.toFixed(2);
            document.getElementById('total-savings-kwh').innerText = stats.total_savings_kwh.toFixed(2);
            document.getElementById('total-savings-oil').innerText = (stats.total_savings_oil_liters || 0).toFixed(3);

            // OLD: Power/Baseline update logic removed from here
            // It is now handled by 'grid_monitor_update' for real facility power.

        }

        // 新增：处理 Monitor 数据并更新报警与原理图状态
        function updateMonitorUI(data) {
            // 1. Update Principle Diagram Animation (Simulation of data flow)
            const monitorNode = document.getElementById('node-monitor');
            const detectNode = document.getElementById('node-detect');
            const actNode = document.getElementById('node-act');

            if (monitorNode && detectNode && actNode) {
                // Simple visual sequence
                monitorNode.classList.add('active');
                setTimeout(() => {
                    monitorNode.classList.remove('active');
                    detectNode.classList.add('active');
                }, 500);
                setTimeout(() => {
                    detectNode.classList.remove('active');
                    if (data.alerts && data.alerts.length > 0) actNode.classList.add('active');
                }, 1000);
                setTimeout(() => actNode.classList.remove('active'), 2000);
            }

            // 2. Render Alerts
            const container = document.getElementById('alerts-container');
            if (container) {
                container.innerHTML = ''; // Clear old

                if (!data.alerts || data.alerts.length === 0) {
                    container.innerHTML = `
                        <div class="alert-item alert-notice" style="border-color: var(--accent-green); color: var(--accent-green);">
                            <span><i class="ri-checkbox-circle-line"></i> 系统正常。正在执行优化策略。</span>
                            <span class="alert-confidence">100%</span>
                        </div>
                        <div class="alert-item alert-notice">
                             <span><i class="ri-lightbulb-line"></i> 提示：保持当前张力控制以获得最佳纱线用量。</span>
                        </div>
                     `;
                } else {
                    data.alerts.forEach(alertObj => {
                        // Backwards compatibility if alert is just string
                        let rawMsg = alertObj;
                        let type = 'alert-notice';
                        let conf = 'Low';
                        let icon = '<i class="ri-information-line"></i>'; // Default icon

                        if (typeof alertObj === 'object') {
                            rawMsg = alertObj.msg;
                            if (alertObj.level === 'CRITICAL') {
                                type = 'alert-critical';
                                icon = '<i class="ri-alarm-warning-line"></i>';
                            } else if (alertObj.level === 'WARNING') {
                                type = 'alert-warning';
                                icon = '<i class="ri-alert-line"></i>';
                            }
                            conf = alertObj.confidence || 'Medium';
                        } else {
                            // Guess type from string content
                            if (rawMsg.includes('严重') || rawMsg.includes('High')) {
                                type = 'alert-critical';
                                icon = '<i class="ri-alarm-warning-line"></i>';
                            } else if (rawMsg.includes('⚠️') || rawMsg.includes('Warning') || rawMsg.includes('空转')) {
                                type = 'alert-warning';
                                icon = '<i class="ri-alert-line"></i>';
                            }
                        }

                        // Clean emojis from backend message
                        let paramMsg = rawMsg.replace(/⚠️|⚡|✅|ℹ️/g, '').trim();

                        const div = document.createElement('div');
                        div.className = `alert-item ${type}`;
                        div.innerHTML = `
                            <span>${icon} ${paramMsg}</span>
                            <span class="alert-confidence">Conf: ${conf}</span>
                        `;
                        container.appendChild(div);
                    });
                }
            }
        }

        // [NEW] Handle Disconnection (Ghost Cards Fix)
        socket.on('device_disconnected', (data) => {
            console.log("Device Disconnected:", data);
            const cleanId = data.ip.replace(/\./g, '-');
            // Try disabling both potential types since ID might be generic or specific
            // Actually, we use ID scheme `dev-{cleanIP}-{lub/ten}`
            ['lub', 'ten'].forEach(suffix => {
                const cardId = `dev-${cleanId}-${suffix}`;
                const card = document.getElementById(cardId);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.filter = 'grayscale(100%)';

                    // Mark title
                    const title = card.querySelector('.device-name');
                    if (title && !title.innerText.includes('OFFLINE')) {
                        title.innerText += ' (OFFLINE)';
                    }

                    // Disable buttons
                    const btns = card.querySelectorAll('button');
                    btns.forEach(btn => btn.disabled = true);
                }
            });
        });

        // [NEW] 按钮防抖状态管理
        const buttonState = {};  // { 'ip_type': { lastAction: string, cooldownUntil: timestamp } }
        const COOLDOWN_MS = 5000;  // 5秒冷却时间

        // 检查按钮是否被阻止
        function isButtonBlocked(ip, type, action) {
            const key = `${ip}_${type}`;
            const state = buttonState[key];
            if (!state) return { blocked: false };

            const now = Date.now();
            const lastAction = state.lastAction;
            const cooldownUntil = state.cooldownUntil || 0;

            // 规则1: 相同操作不能连续执行
            if (lastAction === action) {
                return { blocked: true, reason: `不能连续执行${getActionName(action)}操作` };
            }

            // 规则2: 停止/启动互斥，需要等待冷却
            if ((lastAction === 'STOP' && action === 'START') ||
                (lastAction === 'START' && action === 'STOP')) {
                if (now < cooldownUntil) {
                    const remainSec = Math.ceil((cooldownUntil - now) / 1000);
                    return { blocked: true, reason: `请等待 ${remainSec} 秒后再操作`, remainSec };
                }
            }

            return { blocked: false };
        }

        // 获取操作中文名
        function getActionName(action) {
            const names = {
                'STOP': '紧急停止',
                'START': '重新启动',
                'INJECT': '强制注油',
                'OPTIMIZE_TENSION': '强制优化'
            };
            return names[action] || action;
        }

        // 更新按钮状态
        function updateButtonState(ip, type, action) {
            const key = `${ip}_${type}`;
            const needsCooldown = (action === 'STOP' || action === 'START');
            buttonState[key] = {
                lastAction: action,
                cooldownUntil: needsCooldown ? Date.now() + COOLDOWN_MS : 0
            };
        }

        // [NEW] Control Device Logic with Auth & Cache + 防抖机制
        async function controlDevice(ip, type, action) {
            try {
                // 防抖检查
                const blockCheck = isButtonBlocked(ip, type, action);
                if (blockCheck.blocked) {
                    alert(`⚠️ 操作被阻止：${blockCheck.reason}`);
                    return;
                }

                // Auth Prompt
                const password = prompt("请输入管理员密码以执行此操作:", "");
                if (password === null) return; // Cancelled

                // Visual feedback
                const btn = event.currentTarget;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="ri-loader-4-line"></i> Sending...';

                const res = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip, type: type, action: action, password: password })
                });

                if (res.status === 401) {
                    btn.innerHTML = '<i class="ri-lock-line"></i> Denied';
                    setTimeout(() => btn.innerHTML = originalContent, 2000);
                    alert("密码错误，操作被拒绝！");
                    return;
                }

                const data = await res.json();

                if (data.status === 'queued') {
                    // 操作成功，更新防抖状态
                    updateButtonState(ip, type, action);

                    btn.innerHTML = '<i class="ri-check-line"></i> Queued';
                    setTimeout(() => btn.innerHTML = originalContent, 2000);
                } else {
                    btn.innerHTML = '<i class="ri-close-line"></i> Error';
                    setTimeout(() => btn.innerHTML = originalContent, 2000);
                }
            } catch (e) {
                alert('Command failed: ' + e);
            }
        }

        // [MODIFIED] Dynamic Render
        function updateDeviceUI(dev) {



            if (!dev.ip) {
                // Try to fallback or return if IP missing (will fix backend momentarily)
                // console.warn("Device update missing IP", dev);
                return;
            }

            const cleanId = dev.ip.replace(/\./g, '-');
            const typeSuffix = dev.type === 'LUBRICATION_BOT' ? 'lub' : 'ten';
            const cardId = `dev-${cleanId}-${typeSuffix}`;
            const container = document.getElementById('devices-container');

            let card = document.getElementById(cardId);

            if (!card) {
                // CREATE NEW CARD
                let tplId = "";
                if (dev.type === 'LUBRICATION_BOT') tplId = 'tpl-lub-card';
                else if (dev.type === 'TENSION_BOT') tplId = 'tpl-ten-card';
                else return; // Unknown type

                const tpl = document.getElementById(tplId);
                const clone = tpl.content.cloneNode(true);
                const cardDiv = clone.querySelector('.device-card');
                cardDiv.id = cardId;

                // Setup Bindings
                // Title
                cardDiv.querySelector('.device-name').innerText = `${dev.type === 'LUBRICATION_BOT' ? 'LubBot' : 'TensBot'} (${dev.ip})`;

                // Control Buttons
                const btnInject = cardDiv.querySelector('.btn-control-inject');
                if (btnInject) btnInject.onclick = (e) => controlDevice(dev.ip, dev.type, 'INJECT');

                const btnOpt = cardDiv.querySelector('.btn-control-optimize');
                if (btnOpt) btnOpt.onclick = (e) => controlDevice(dev.ip, dev.type, 'OPTIMIZE_TENSION');

                const btnStop = cardDiv.querySelector('.btn-control-stop');
                if (btnStop) btnStop.onclick = (e) => controlDevice(dev.ip, dev.type, 'STOP');

                const btnStart = cardDiv.querySelector('.btn-control-start');
                if (btnStart) btnStart.onclick = (e) => controlDevice(dev.ip, dev.type, 'START');

                container.appendChild(clone);
                card = document.getElementById(cardId);
            }

            // UPDATE VALUES
            const dData = dev.data;
            const stats = dev.stats || {};
            let isAlarm = false;

            if (dev.type === 'LUBRICATION_BOT') {
                card.querySelector('.val-temp').innerText = dData.temperature_c;
                card.querySelector('.val-current').innerText = dData.current_a;
                card.querySelector('.val-count').innerText = stats.inject_count || 0;

                const bar = card.querySelector('.bar-temp');
                if (bar) bar.style.width = Math.min(100, Math.max(0, (dData.temperature_c - 20) / 60 * 100)) + '%';

                const msg = dData.action === 'MONITOR' ? 'Monitor Running...' : `>> ACTION: ${dData.action}`;
                card.querySelector('.val-log').innerHTML = `<div><span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`;

                if (dData.action === 'INJECT' || dData.temperature_c > 50) isAlarm = true;
            }
            else if (dev.type === 'TENSION_BOT') {
                card.querySelector('.val-tension').innerText = dData.tension;
                card.querySelector('.val-yarn').innerText = dData.yarn_pct;
                card.querySelector('.val-count').innerText = stats.optimize_count || 0;

                const bar = card.querySelector('.bar-tension');
                if (bar) bar.style.width = Math.min(100, Math.max(0, dData.tension / 10 * 100)) + '%';

                const msg = dData.action === 'MONITOR' ? 'Status: Optimal' : `>> ACTION: ${dData.action}`;
                card.querySelector('.val-log').innerHTML = `<div><span style="opacity:0.5">[${new Date().toLocaleTimeString()}]</span> ${msg}</div>`;

                if (dData.action === 'ALARM_STOP') isAlarm = true;
            }

            if (isAlarm) card.classList.add('alarm-border');
            else card.classList.remove('alarm-border');
        }

        // New: Time and Date Display
        function updateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };

            const timeString = now.toLocaleTimeString('zh-CN', timeOptions);
            const dateString = now.toLocaleDateString('zh-CN', dateOptions).replace(/\//g, '-');

            const timeEl = document.getElementById('time-display');
            const dateEl = document.getElementById('date-display');

            if (timeEl) timeEl.innerText = timeString;
            if (dateEl) dateEl.innerText = dateString;
        }

        // New: View Switching Logic
        function switchView(viewId, clickedElement) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`view-${viewId}`).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            clickedElement.classList.add('active');
        }

        // Helper to add log
        function addLogToTable(log) {
            const logsTableBody = document.getElementById('logs-table-body');
            if (!logsTableBody) return;

            const row = logsTableBody.insertRow(0); // Insert at the top
            const timeCell = row.insertCell(0);
            const typeCell = row.insertCell(1);
            const detailCell = row.insertCell(2);
            const snapshotCell = row.insertCell(3);

            timeCell.innerText = log.timestamp || new Date().toLocaleTimeString('zh-CN');

            let typeClass = 'log-type-info';
            const evt = (log.event_type || '').toUpperCase();
            const msg = (log.message || '').toUpperCase();

            // Logic to guess severity/color
            if (evt.includes('WARNING') || msg.includes('WARNING') || msg.includes('警告')) {
                typeClass = 'log-type-warning';
            } else if (evt.includes('ERROR') || msg.includes('ERROR') || msg.includes('错误') || msg.includes('故障')) {
                typeClass = 'log-type-error';
            } else if (evt.includes('SUCCESS') || msg.includes('SUCCESS') || msg.includes('完成')) {
                typeClass = 'log-type-success';
            } else if (evt.includes('AI') || evt.includes('BOT') || msg.includes('自动') || msg.includes('优化')) {
                if (msg.includes('喷油') || msg.includes('调整')) {
                    typeClass = 'log-type-ai';
                }
            }

            let typeIcon = '';
            if (typeClass === 'log-type-warning') typeIcon = '<i class="ri-alert-line"></i> ';
            else if (typeClass === 'log-type-error') typeIcon = '<i class="ri-alarm-warning-line"></i> ';
            else if (typeClass === 'log-type-ai') typeIcon = '<i class="ri-robot-2-line"></i> ';
            else typeIcon = '<i class="ri-information-line"></i> ';

            typeCell.innerHTML = `<span class="${typeClass}">${typeIcon}${log.event_type}</span>`;

            detailCell.className = 'log-detail';
            detailCell.innerText = log.message;

            snapshotCell.className = 'log-snapshot';
            const snapData = log.details || log.data;
            snapshotCell.innerText = snapData && Object.keys(snapData).length > 0 ? JSON.stringify(snapData) : '-';

            // Keep only the last 50 logs
            while (logsTableBody.rows.length > 50) {
                logsTableBody.deleteRow(logsTableBody.rows.length - 1);
            }
        }

        // New: Log Table Update (Realtime)
        socket.on('system_log_new', (log) => {
            addLogToTable(log);
        });

        // New: Log Table History (On Connect)
        socket.on('system_log_history', (logs) => {
            if (!logs || !Array.isArray(logs)) return;
            // Clear existing? Maybe not, just prepend.
            // But usually this replaces. Let's clear to be safe or just add.
            // If we verify that history is only sent on connect, clearing is safer.
            const logsTableBody = document.getElementById('logs-table-body');
            if (logsTableBody) logsTableBody.innerHTML = '';

            // Logs are [Newest, ..., Oldest]
            // We want to insert Oldest first (at 0), then ..., then Newest (at 0)
            // So that Newest ends up at 0.
            // So reverse logs list -> [Oldest, ..., Newest]
            // Then iterate.
            [...logs].reverse().forEach(log => addLogToTable(log));
        });
        // New: Settings Logic
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const conf = await res.json();
                if (document.getElementById('setting-elec-price')) document.getElementById('setting-elec-price').value = conf.ELECTRICITY_PRICE;
                if (document.getElementById('setting-oil-price')) document.getElementById('setting-oil-price').value = conf.OIL_PRICE;
                if (document.getElementById('setting-inject-vol')) document.getElementById('setting-inject-vol').value = conf.AI_INJECT_VOLUME;
            } catch (e) { console.error("Load settings failed", e); }
        }

        async function saveSettings() {
            const status = document.getElementById('settings-status');
            status.innerText = "Savings...";
            status.style.color = "#ccc";

            const payload = {
                ELECTRICITY_PRICE: parseFloat(document.getElementById('setting-elec-price').value),
                OIL_PRICE: parseFloat(document.getElementById('setting-oil-price').value),
                AI_INJECT_VOLUME: parseFloat(document.getElementById('setting-inject-vol').value)
            };

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                status.innerText = "✅ Saved successfully!";
                status.style.color = "var(--accent-green)";
                setTimeout(() => status.innerText = "", 3000);
            } catch (e) {
                status.innerText = "❌ Save failed";
                status.style.color = "var(--accent-red)";
            }
        }

        // Hook switchView to load settings when opening settings tab
        const originalSwitchView = switchView;
        switchView = function (viewId, clickedElement) {
            originalSwitchView(viewId, clickedElement);
            if (viewId === 'settings') {
                loadSettings();
            } else if (viewId === 'devices') {
                fetchDeviceList();
            }
        }

        // [NEW] Fetch Device List from InfluxDB
        async function fetchDeviceList() {
            try {
                const grid = document.getElementById('device-grid');
                grid.innerHTML = '<div style="color: var(--text-muted); padding: 20px;">Loading devices from InfluxDB...</div>';

                const res = await fetch('/api/devices/list');
                const devices = await res.json();

                if (devices.error) {
                    grid.innerHTML = `<div style="color: var(--accent-red); padding: 20px;">Error: ${devices.error}</div>`;
                    return;
                }

                grid.innerHTML = ''; // Clear loading

                if (devices.length === 0) {
                    grid.innerHTML = `<div style="color: var(--text-muted); padding: 20px;">No devices found in database.</div>`;
                    return;
                }

                devices.forEach(devId => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';
                    card.style.alignItems = 'center';
                    card.style.justifyContent = 'center';
                    card.style.padding = '30px 20px';
                    card.style.textAlign = 'center';
                    card.style.cursor = 'pointer';
                    card.style.transition = 'all 0.3s';

                    // Determine icon and color based on name
                    let icon = 'ri-server-line';
                    let color = 'var(--accent-blue)';

                    if (devId.includes('energy')) {
                        icon = 'ri-flashlight-line';
                        color = 'var(--accent-blue)';
                    }

                    card.innerHTML = `
                        <div style="width: 56px; height: 56px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                            <i class="${icon}" style="font-size: 28px; color: ${color};"></i>
                        </div>
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 6px; color: var(--text-primary);">${devId}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Available</div>
                    `;

                    // Add hover effect
                    card.onmouseover = function () {
                        this.style.transform = 'translateY(-4px)';
                        this.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
                    };
                    card.onmouseout = function () {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '';
                    };
                    // Add click event to switch device
                    card.onclick = () => switchToDevice(devId);

                    grid.appendChild(card);
                });
            } catch (e) {
                console.error("Failed to fetch devices", e);
                document.getElementById('device-grid').innerHTML = `<div style="color: var(--accent-red); padding: 20px;">Network Error</div>`;
            }
        }

        // [NEW] Switch to device and go to dashboard
        async function switchToDevice(deviceId) {
            try {
                // 1. Call backend to switch device
                await fetch(`/api/devices/switch/${encodeURIComponent(deviceId)}`, { method: 'POST' });

                // 2. Update dashboard title
                document.getElementById('current-device-label').innerText = deviceId;

                // 3. Switch to dashboard view
                switchView('dashboard', document.querySelector('[onclick*="dashboard"]'));

                console.log(`Switched to device: ${deviceId}`);
            } catch (e) {
                console.error('Failed to switch device', e);
                alert('切换设备失败: ' + e.message);
            }
        }
    </script>
    <!-- AI Assistant Floating Button -->
    <div id="ai-fab" onclick="toggleChat()" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: transform 0.2s;
    ">
        <i class="ri-customer-service-2-line" style="font-size: 30px;"></i>
    </div>

    <!-- AI Chat Window -->
    <div id="ai-chat-window" style="
        display: none;
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 350px;
        height: 500px;
        background: #1e293b;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 16px;
        z-index: 1000;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    ">
        <!-- Header -->
        <div
            style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); border-radius: 16px 16px 0 0;">
            <span style="font-weight: 600; color: #fff;">能耗助手</span>
            <span onclick="toggleChat()" style="cursor: pointer; opacity: 0.7;">✕</span>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages"
            style="flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
            <div
                style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; align-self: flex-start; max-width: 85%; color: #ccc; font-size: 13px;">
                你好！我可以为您总结能耗和空转数据。有什么可以帮您？
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px;">
            <input type="text" id="ai-input" placeholder="请输入问题..." style="
                flex: 1;
                background: rgba(0,0,0,0.3);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                padding: 8px 12px;
                color: #fff;
                outline: none;
            " onkeypress="if(event.key === 'Enter') sendAiMessage()">
            <button onclick="sendAiMessage()" style="
                background: #6366f1;
                border: none;
                border-radius: 8px;
                padding: 0 16px;
                color: #fff;
                cursor: pointer;
            ">➤</button>
        </div>
    </div>

    <!-- 开屏动画控制脚本 -->
    <script>
        // 开屏动画控制
        (function () {
            const splashScreen = document.getElementById('splash-screen');
            const appLayout = document.querySelector('.app-layout');
            const loadingText = document.querySelector('.splash-loading-text');

            // 动态更新加载文字
            const loadingMessages = [
                '系统初始化中...',
                '加载数据源...',
                '连接服务器...',
                '准备就绪'
            ];

            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                messageIndex++;
                if (messageIndex < loadingMessages.length && loadingText) {
                    loadingText.textContent = loadingMessages[messageIndex];
                }
            }, 600);

            // 页面加载完成后隐藏开屏动画
            window.addEventListener('load', function () {
                setTimeout(() => {
                    clearInterval(messageInterval);
                    if (loadingText) {
                        loadingText.textContent = '启动完成';
                    }

                    // 淡出开屏动画
                    setTimeout(() => {
                        if (splashScreen) {
                            splashScreen.classList.add('fade-out');
                        }

                        // 显示主内容
                        setTimeout(() => {
                            if (appLayout) {
                                appLayout.classList.add('visible');
                            }

                            // 完全移除开屏动画元素
                            setTimeout(() => {
                                if (splashScreen) {
                                    splashScreen.remove();
                                }
                            }, 800);
                        }, 300);
                    }, 300);
                }, 2000); // 总加载动画时间 2 秒
            });
        })();
    </script>
</body>

</html>